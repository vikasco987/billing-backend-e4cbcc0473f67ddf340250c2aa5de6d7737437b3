generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ===================== ENUMS =====================

enum Role {
  USER
  user
  ADMIN
  admin
  SELLER
  seller
}

enum FieldType {
  INPUT
  SELECT
  CHECKBOX
  RADIO
  FILE
}

// ===================== CATEGORY =====================

model Category {
  id       String     @id @default(auto()) @map("_id") @db.ObjectId
  name     String
  parentId String?    @db.ObjectId
  parent   Category?  @relation("Subcategories", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children Category[] @relation("Subcategories")
  items    Item[]

  // ⭐ REQUIRED FOR InventoryItem
  inventoryItems InventoryItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===================== ITEM =====================

model Item {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  description   String?
  price         Float?
  mrp           Float?
  purchasePrice Float?
  sellingPrice  Float?
  gst           Float?
  discount      Float?
  stock         Int?
  openingStock  Int?
  currentStock  Int?
  reorderLevel  Int?
  unit          String?
  barcode       String?
  brand         String?
  model         String?
  size          String?
  color         String?
  variants      Json?
  imageUrl      String?
  gallery       String[]

  categoryId String   @db.ObjectId
  category   Category @relation(fields: [categoryId], references: [id])

  clerkId String
  userId  String @db.ObjectId
  user    User   @relation(fields: [userId], references: [id])

  purchases PurchaseItem[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

// ===================== PARTY =====================

model Party {
  id      String    @id @default(auto()) @map("_id") @db.ObjectId
  name    String
  phone   String    @unique
  address String?
  dob     DateTime?

  createdBy String
  user      User?  @relation(fields: [createdBy], references: [clerkId])

  bills     Bill[]
  createdAt DateTime @default(now())
}

// ===================== PRODUCT =====================

model Product {
  id    String        @id @default(auto()) @map("_id") @db.ObjectId
  name  String
  price Float
  bills BillProduct[]
}

// ===================== BILL =====================

model Bill {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  userId        String        @db.ObjectId
  clerkUserId   String?
  user          User          @relation(fields: [userId], references: [id])
  customerId    String?       @db.ObjectId
  customer      Party?        @relation(fields: [customerId], references: [id])
  products      BillProduct[]
  total         Float
  discount      Float?
  gst           Float?
  grandTotal    Float?
  paymentStatus String?
  paymentMode   String?
  notes         String?
  dueDate       DateTime?

  holdBy    String?
  holdAt    DateTime?
  resumedAt DateTime?
  isHeld    Boolean   @default(false)

  companyName    String?
  companyAddress String?
  companyPhone   String?
  contactPerson  String?
  logoUrl        String?
  signatureUrl   String?
  websiteUrl     String?

  payments  Payment[]
  history   BillHistory[]
  createdAt DateTime      @default(now())
}

// ===================== BILL PRODUCT =====================

model BillProduct {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  billId      String   @db.ObjectId
  productId   String   @db.ObjectId
  productName String?
  bill        Bill     @relation(fields: [billId], references: [id])
  product     Product? @relation(fields: [productId], references: [id])
  quantity    Int
  price       Float
  discount    Float?
  gst         Float?
  total       Float?
}

// ===================== BILL HISTORY =====================

model BillHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  billId    String   @db.ObjectId
  bill      Bill     @relation(fields: [billId], references: [id])
  snapshot  Json
  createdAt DateTime @default(now())
}

// ===================== PAYMENT =====================

model Payment {
  id     String   @id @default(auto()) @map("_id") @db.ObjectId
  billId String   @db.ObjectId
  bill   Bill     @relation(fields: [billId], references: [id])
  amount Float
  mode   String
  paidAt DateTime @default(now())
}

// ===================== PURCHASE =====================

model Purchase {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  vendorId    String
  userId      String
  user        User           @relation(fields: [userId], references: [clerkId])
  totalAmount Float
  invoiceNo   String?
  status      String?
  items       PurchaseItem[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model PurchaseItem {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  purchaseId String   @db.ObjectId
  itemId     String   @db.ObjectId
  quantity   Int
  price      Float
  purchase   Purchase @relation(fields: [purchaseId], references: [id])
  item       Item     @relation(fields: [itemId], references: [id])

  // ⭐ REQUIRED FOR InventoryItem
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id])
}

// ===================== USER =====================

model User {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  email           String            @unique
  clerkId         String            @unique
  role            Role              @default(USER)
  bills           Bill[]
  items           Item[]
  forms           Form[]
  profiles        BusinessProfile[]
  uploads         Upload[]
  purchases       Purchase[]
  parties         Party[]
  profilesCreated BusinessProfile[] @relation("ProfileCreator")

  // ⭐ REQUIRED FOR InventoryItem
  inventoryItems InventoryItem[]
}

// ===================== FORM =====================

model Form {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  fields    Field[]
  userId    String
  user      User     @relation(fields: [userId], references: [clerkId])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Field {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  formId    String    @db.ObjectId
  form      Form      @relation(fields: [formId], references: [id])
  label     String
  type      FieldType
  required  Boolean   @default(false)
  options   String[]
  value     String?
  values    String[]
  fileUrl   String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ===================== BUSINESS PROFILE =====================

model BusinessProfile {
  id                 String  @id @default(auto()) @map("_id") @db.ObjectId
  userId             String
  user               User    @relation(fields: [userId], references: [clerkId])
  createdBy          String
  creator            User?   @relation("ProfileCreator", fields: [createdBy], references: [clerkId])
  businessType       String?
  businessName       String?
  businessTagLine    String?
  contactPersonName  String?
  contactPersonPhone String?
  contactPersonEmail String?
  upi                String?
  googleReviewUrl    String?
  profileImageUrl    String?
  logoUrl            String?
  signatureUrl       String?

  gstNumber       String?
  businessAddress String?
  state           String?
  pinCode         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===================== UPLOAD =====================

model Upload {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  text      String?
  imageUrl  String
  userId    String
  user      User     @relation(fields: [userId], references: [clerkId])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ===================== DELETE HISTORY =====================

model DeleteHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  billId    String
  deletedBy String?
  snapshot  Json
  deletedAt DateTime @default(now())
}

// ===================== INVENTORY ITEM =====================

model InventoryItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  description   String?
  price         Float?
  mrp           Float?
  purchasePrice Float?
  sellingPrice  Float?
  gst           Float?
  discount      Float?
  stock         Int?
  openingStock  Int?
  currentStock  Int?
  reorderLevel  Int?
  unit          String?
  barcode       String?
  brand         String?
  model         String?
  size          String?
  color         String?
  variants      Json?
  imageUrl      String?
  gallery       String[]

  searchKey   String?
  autoMatched Boolean? @default(false)
  externalRef String?
  slug        String?  @unique
  tags        String[]

  categoryId String   @db.ObjectId
  category   Category @relation(fields: [categoryId], references: [id])

  clerkId String
  userId  String @db.ObjectId
  user    User   @relation(fields: [userId], references: [id])

  purchases PurchaseItem[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([searchKey])
  @@index([externalRef])
}
